{% extends 'base.html' %}

{% block title %}Audit Logs{% endblock %}

{% block content %}
<div class="row">
  <div class="col s12">
    <h4>Audit Logs</h4>
    <p class="grey-text">System-wide security and action logging</p>

    <!-- Filters -->
    <div class="card">
      <div class="card-content">
        <span class="card-title">Filters</span>
        <form method="GET" action="{% url 'audit_log_list' %}">
          <div class="row">
            <div class="col s12 m3">
              <select name="action" class="browser-default">
                <option value="">All Actions</option>
                {% for action_code, action_name in actions %}
                  <option value="{{ action_code }}" {% if action_filter == action_code %}selected{% endif %}>
                    {{ action_name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col s12 m3">
              <select name="status" class="browser-default">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                  <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}>
                    {{ status|title }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col s12 m3">
              <input type="text" name="user" placeholder="Filter by username" value="{{ user_filter }}" class="browser-default">
            </div>

            <div class="col s12 m3">
              <input type="text" name="search" placeholder="Search details or IP" value="{{ search }}" class="browser-default">
            </div>
          </div>

          <div class="row">
            <div class="col s12">
              <button type="submit" class="btn blue darken-2 waves-effect waves-light">
                <i class="material-icons left">filter_list</i>Apply Filters
              </button>
              <a href="{% url 'audit_log_list' %}" class="btn-flat">Clear Filters</a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Audit Logs Table -->
    {% if page_obj %}
    <table class="striped responsive-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Timestamp</th>
          <th>User</th>
          <th>Action</th>
          <th>Status</th>
          <th>Incident</th>
          <th>IP Address</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for log in page_obj %}
        <tr>
          <td>{{ log.id }}</td>
          <td>{{ log.timestamp|date:"M d, Y H:i:s" }}</td>
          <td>
            {% if log.user %}
              {{ log.user.username }}
            {% else %}
              <span class="grey-text">Anonymous</span>
            {% endif %}
          </td>
          <td>
            <span class="badge blue darken-2 white-text">{{ log.get_action_display }}</span>
          </td>
          <td>
            {% if log.status == 'success' %}
              <span class="badge green white-text">Success</span>
            {% else %}
              <span class="badge red white-text">Failed</span>
            {% endif %}
          </td>
          <td>
            {% if log.incident %}
              <a href="{% url 'incident_detail' log.incident.pk %}">#{{ log.incident.id }}</a>
            {% else %}
              <span class="grey-text">N/A</span>
            {% endif %}
          </td>
          <td>{{ log.ip_address|default:"N/A" }}</td>
          <td>
            {{ log.details|truncatewords:10|default:"N/A" }}
            <a href="{% url 'audit_log_detail' log.pk %}" class="blue-text">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="center-align" style="margin-top: 20px;">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="waves-effect"><a href="?page=1{% if action_filter %}&action={{ action_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"><i class="material-icons">first_page</i></a></li>
          <li class="waves-effect"><a href="?page={{ page_obj.previous_page_number }}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"><i class="material-icons">chevron_left</i></a></li>
        {% endif %}

        <li class="active blue darken-2"><a href="#">{{ page_obj.number }}</a></li>

        {% if page_obj.has_next %}
          <li class="waves-effect"><a href="?page={{ page_obj.next_page_number }}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"><i class="material-icons">chevron_right</i></a></li>
          <li class="waves-effect"><a href="?page={{ page_obj.paginator.num_pages }}{% if action_filter %}&action={{ action_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}"><i class="material-icons">last_page</i></a></li>
        {% endif %}
      </ul>
      <p>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} (Total: {{ page_obj.paginator.count }} logs)</p>
    </div>

    {% else %}
    <div class="card-panel center-align">
      <p class="flow-text">No audit logs found.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
